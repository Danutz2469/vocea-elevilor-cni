<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Hub - Portal Comunitar</title>
    <style>
        /* --- CSS-ul Minimal Necesare pentru Func»õionalitatea Codului --- */
        :root {
            --primary: #1e3a8a; /* Indigo 800 */
            --accent: #fcd34d; /* Amber 300 */
            --muted: #6b7280; /* Gray 500 */
            --background: #f9fafb; /* Gray 50 */
            --probleme-color: #ef4444; /* Red 500 */
            --sugestii-color: #10b981; /* Emerald 500 */
            --acad-color: #3b82f6; /* Blue 500 */
            --resurse-color: #8b5cf6; /* Violet 500 */
            --bullying-color: #991b1b; /* Red 800 */
        }

        body {
            font-family: sans-serif;
            margin: 0;
            background-color: var(--background);
            color: #1f2937;
            padding-top: 60px; /* Pentru a face loc headerului fix */
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .nav-links {
            display: none;
        }

        .burger.open + .nav-links {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 60px;
            left: 0;
            width: 100%;
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }

        .burger {
            cursor: pointer;
            padding: 5px;
        }

        /* ADMIN UI STYLES */
        .admin-visible {
            grid-template-columns: 250px 1fr !important;
        }
        
        #mainGrid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1200px;
            margin: auto;
        }

        #adminSidebar {
            background-color: #1f2937;
            color: white;
            padding: 20px;
            display: none; /* Ascuns implicit */
        }

        #adminSidebar.admin-visible {
            display: block;
        }
        
        /* CARD STYLES */
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .card.revealed {
            opacity: 1;
            transform: translateY(0);
        }

        .list-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .item {
            background-color: #fff;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .thumb {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            background-color: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumb svg {
            width: 30px;
            height: 30px;
            color: #fff;
        }

        .status {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            color: white;
        }

        .status.open { background-color: var(--probleme-color); }
        .status.progress { background-color: var(--acad-color); }
        .status.resolved { background-color: var(--sugestii-color); }

        .meta {
            font-size: 11px;
            color: var(--muted);
        }

        .btn {
            background-color: var(--primary);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .btn:hover { background-color: #1f377a; }
        .btn.urgent { background-color: var(--probleme-color); }
        .btn.urgent:hover { background-color: #c93434; }

        /* Form Styling */
        form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        form input, form select, form textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* Comments Styling */
        .comments-section {
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 10px;
        }

        .comment-item {
            background-color: #fafafa;
            padding: 8px;
            border-left: 3px solid var(--accent);
            margin-bottom: 5px;
            font-size: 13px;
        }

        .comment-meta {
            display: block;
            font-size: 11px;
            color: var(--muted);
            margin-top: 2px;
        }

        .comment-form-container {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .comment-form-container textarea {
            flex-grow: 1;
            min-height: 40px;
            resize: none;
        }

        /* Progress Bar */
        #progressContainer {
            margin-bottom: 20px;
        }
        .progress-bar-container {
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            height: 20px;
        }
        #progressBar {
            height: 100%;
            background-color: var(--sugestii-color);
            transition: width 0.5s ease;
            text-align: center;
            color: white;
            line-height: 20px;
        }
        #progressPercent {
            display: inline-block;
            margin-left: 5px;
            font-weight: 600;
        }
        #counts {
            font-size: 12px;
            color: var(--muted);
            margin-top: 5px;
        }
        
        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 16px;
            position: fixed;
            z-index: 1001;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadeout {
            from {opacity: 1;}
            to {opacity: 0;}
        }

        /* Sondaj Bars */
        .bar {
            height: 10px;
            background: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
        }
        .bar span {
            display: block;
            height: 100%;
            background: var(--accent);
            transition: width 0.5s ease;
        }
        
        /* Back to Top Button */
        #toTop {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--primary);
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            font-size: 18px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #toTop.show {
            display: block;
        }
        
        /* Responsive Grid Adjustments */
        @media (min-width: 768px) {
            .nav-links {
                display: flex !important; /* Force flex on desktop */
                position: static !important;
                box-shadow: none !important;
                flex-direction: row !important;
                gap: 20px;
            }
            .burger {
                display: none;
            }
            #mainGrid {
                grid-template-columns: 1fr 1fr 1fr;
            }
            #adminSidebar {
                grid-row: 1 / 4;
                grid-column: 1 / 2;
                display: none;
            }
            #adminSidebar.admin-visible {
                 display: block;
            }
            .main-content {
                grid-column: span 3;
            }
            .admin-visible .main-content {
                grid-column: 2 / 4;
            }
            
            /* Admin Layout Fix */
            .admin-visible .card.full-width {
                grid-column: 2 / 4;
            }
        }
        /* ADMIN CONTROLS */
        .admin-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            align-items: center;
        }
        .admin-controls select {
            padding: 5px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div id="toast"></div>

    <header>
        <div class="logo">üè´ School Hub</div>
        <div class="burger" id="burger">‚ò∞</div>
        <nav class="nav-links" id="navLinks">
            <button id="toggleAdmin">IntrƒÉ Mod Admin</button>
            <span style="display:flex; align-items:center;">
                Anun»õuri 
                <span id="announcement-badge" class="status open" style="margin-left: 5px; display: none;">0</span>
            </span>
        </nav>
    </header>

    <button onclick="window.scrollTo({ top: 0, behavior: 'smooth' })" id="toTop">‚ñ≤</button>
    
    <main id="mainGrid">

        <aside id="adminSidebar">
            <h3 style="margin-top: 0; color:var(--accent);">Administrare</h3>
            
            <div id="progressContainer" style="display: none; margin-bottom: 20px;">
                <h4 style="margin-bottom: 5px; color:white;">Status Probleme/Academice</h4>
                <div class="progress-bar-container">
                    <span id="progressBar" style="width: 0%;">
                        <span id="progressPercent">0%</span>
                    </span>
                </div>
                <div id="counts" style="margin-top: 5px;"></div>
            </div>

            <div id="adminContent" style="display: none;">
                <h4 style="color:var(--accent); margin-top:20px;">AdaugƒÉ Anun»õ</h4>
                <form id="formAnnouncement">
                    <label for="tipAnunt">Tip Anun»õ:</label>
                    <select id="tipAnunt">
                        <option value="General">General</option>
                        <option value="Eveniment">Eveniment</option>
                        <option value="Urgent">Urgent</option>
                    </select>
                    <label for="descrAnunt">Text Anun»õ:</label>
                    <textarea id="descrAnunt" rows="3"></textarea>
                    <button type="button" class="btn" id="sendAnunt" style="width: 100%;">PublicƒÉ</button>
                </form>

                <h4 style="color:var(--accent); margin-top:20px;">AdaugƒÉ Eveniment</h4>
                <form id="formEvent">
                    <label for="titluEvent">Titlu:</label>
                    <input type="text" id="titluEvent" required>
                    <label for="dataEvent">DatƒÉ:</label>
                    <input type="date" id="dataEvent" required>
                    <button type="button" class="btn" id="sendEvent" style="width: 100%;">AdaugƒÉ</button>
                </form>

                <h4 style="color:var(--accent); margin-top:20px;">Sondaj Admin</h4>
                <div id="adminPollControls">
                    <form id="formNewPoll">
                        <label for="newPollTitle">Titlu Sondaj Nou:</label>
                        <input type="text" id="newPollTitle" placeholder="Ce sƒÉ facem?">
                        <label for="newPollOptions">Op»õiuni (una pe r√¢nd):</label>
                        <textarea id="newPollOptions" rows="3" placeholder="Op»õiunea 1&#10;Op»õiunea 2&#10;..."></textarea>
                        <button type="button" class="btn" id="startNewPoll" style="width: 100%;">LanseazƒÉ Sondaj Nou</button>
                    </form>
                    <button type="button" class="btn urgent" id="resetVote" style="width: 100%; margin-top: 10px;">Reset Voturi Curent</button>
                </div>

                <h4 style="color:var(--accent); margin-top:20px;">Ac»õiuni Periculoase</h4>
                <button type="button" class="btn urgent" id="clearAll" style="width: 100%;">»òterge TOATE Datele</button>

                <h4 id="bullyingListTitle" style="color:var(--accent); margin-top:20px; display:none;">RaportƒÉri Bullying (PRIVATE)</h4>
                <div id="listBullying" class="list-container" style="margin-top: 10px;">
                    </div>
            </div>
        </aside>

        <div class="main-content" style="grid-column: span 3;">
            
            <div class="card full-width" style="margin-bottom: 20px;">
                <h3>üì¢ Anun»õuri Oficiale</h3>
                <div id="announcementsList" class="list-container">
                    </div>
            </div>

            <div class="card">
                <h3>üìä Sondajul Lunii</h3>
                <h4 id="currentPollTitle" style="color:var(--primary);">[Titlu Sondaj]</h4>
                <div id="pollOptions">
                    </div>
                <div id="pollControlsDiv" style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="button" class="btn" id="voteBtn">VoteazƒÉ</button>
                </div>
                <h4 style="margin-top: 20px;">Rezultate:</h4>
                <div id="pollResultsDiv">
                    </div>
            </div>

            <div class="card">
                <h3>üìÖ Calendar »òcolar</h3>
                <div id="calendarList" class="list-container" style="gap:0; border: 1px solid #eee;">
                    </div>
            </div>
            
            <div class="card" style="grid-column: span 3;">
                <h3>üìù Trimite o Sesizare</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    
                    <div style="border: 2px solid var(--probleme-color); padding: 15px; border-radius: 8px;">
                        <h4 style="color:var(--probleme-color); margin-top:0;">Probleme (Loca»õie, Echipament, CurƒÉ»õenie)</h4>
                        <form id="formProbleme">
                            <label for="locatie">Loca»õie specificƒÉ:</label>
                            <input type="text" id="locatie" placeholder="Ex: Sala 204, Curte" required>
                            <label for="tipProblema">Tip problemƒÉ:</label>
                            <select id="tipProblema" required>
                                <option value="">Alege tipul</option>
                                <option value="Echipament stricat">Echipament stricat</option>
                                <option value="Defec»õiuni instala»õii">Defec»õiuni instala»õii</option>
                                <option value="CurƒÉ»õenie">CurƒÉ»õenie</option>
                                <option value="Altele">Altele</option>
                            </select>
                            <label for="descrProblema">Descriere:</label>
                            <textarea id="descrProblema" rows="3" required></textarea>
                            <label for="fotoProblema">Foto (Op»õional, max 300KB):</label>
                            <input type="file" id="fotoProblema" accept="image/*">
                            <div id="previewProblema" style="margin-bottom: 10px; text-align: center;"></div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="btn urgent" id="sendProblemaUrgent" style="flex-grow: 1;">Trimite URGENT</button>
                                <button type="button" class="btn" id="sendProblema" style="flex-grow: 1;">Trimite Normal</button>
                            </div>
                        </form>
                    </div>

                    <div style="border: 2px solid var(--bullying-color); padding: 15px; border-radius: 8px;">
                        <h4 style="color:var(--bullying-color); margin-top:0;">Raportare Bullying/Abuz (Strict Confiden»õial)</h4>
                        <form id="formBullying">
                            <label for="tipBullying">Tip incident (Op»õional):</label>
                            <input type="text" id="tipBullying" placeholder="Agresiune verbalƒÉ, FizicƒÉ, Online">
                            <label for="descrBullying">Descriere incident:</label>
                            <textarea id="descrBullying" rows="3" required></textarea>
                            <label style="display:flex; gap:5px; align-items:center;">
                                <input type="checkbox" id="contactBullying"> Doresc sƒÉ fiu contactat (Introduce»õi email)
                            </label>
                            <input type="email" id="emailBullying" placeholder="Email contact (op»õional)">
                            <button type="button" class="btn urgent" id="sendBullying" style="width: 100%;">Trimite Raportare</button>
                        </form>
                    </div>

                    <div style="border: 2px solid var(--sugestii-color); padding: 15px; border-radius: 8px;">
                        <h4 style="color:var(--sugestii-color); margin-top:0;">Sugestii & Idei Noi</h4>
                        <form id="formSugestii">
                            <label for="numeSug">Nume (Op»õional):</label>
                            <input type="text" id="numeSug" placeholder="Nume, ClasƒÉ (ex: Elev X, 10A)">
                            <label for="descrSug">Descriere Sugestie:</label>
                            <textarea id="descrSug" rows="3" required></textarea>
                            <button type="button" class="btn" id="sendSug" style="width: 100%;">Trimite Sugestia</button>
                        </form>
                    </div>
                    
                    <div style="border: 2px solid var(--acad-color); padding: 15px; border-radius: 8px;">
                        <h4 style="color:var(--acad-color); margin-top:0;">Solicitare Sprijin Academic/Consiliere</h4>
                        <form id="formAcademice">
                            <label for="tipAcad">Domeniu/Tip sprijin:</label>
                            <select id="tipAcad" required>
                                <option value="">Alege domeniul</option>
                                <option value="MatematicƒÉ">MatematicƒÉ</option>
                                <option value="Limba Rom√¢nƒÉ">Limba Rom√¢nƒÉ</option>
                                <option value="Alte discipline">Alte discipline</option>
                                <option value="Consiliere PsihologicƒÉ">Consiliere PsihologicƒÉ</option>
                            </select>
                            <label for="descrAcad">Detalii Solicitare:</label>
                            <textarea id="descrAcad" rows="3" required></textarea>
                            <button type="button" class="btn" id="sendAcad" style="width: 100%;">Trimite Solicitarea</button>
                        </form>
                    </div>

                </div>
            </div>

            <div class="card full-width" style="grid-column: span 3;">
                <h3>üõ†Ô∏è Probleme Raportate</h3>
                <div id="filterProbleme" class="admin-controls" style="margin-bottom: 15px; display: none;">
                    <input type="text" id="searchProbleme" oninput="renderProbleme()" placeholder="CautƒÉ dupƒÉ Loca»õie/Descriere">
                    <select id="statusFilterProbleme" onchange="renderProbleme()">
                        <option value="all">Toate Statusurile</option>
                        <option value="open">OPEN</option>
                        <option value="inprogress">√éN LUCRU</option>
                        <option value="resolved">REZOLVAT</option>
                    </select>
                </div>
                <div id="listProbleme" class="list-container">
                    </div>
            </div>

            <div class="card full-width" style="grid-column: span 3;">
                <h3>üí° Sugestii Publice</h3>
                <div id="listSugestii" class="list-container">
                    </div>
            </div>
            
            <div class="card full-width" style="grid-column: span 3;">
                <h3>üìö SolicitƒÉri Academice</h3>
                <div id="filterAcad" class="admin-controls" style="margin-bottom: 15px; display: none;">
                    <input type="text" id="searchAcad" oninput="renderAcad()" placeholder="CautƒÉ dupƒÉ Tip/Descriere">
                    <select id="statusFilterAcad" onchange="renderAcad()">
                        <option value="all">Toate Statusurile</option>
                        <option value="open">OPEN</option>
                        <option value="inprogress">√éN LUCRU</option>
                        <option value="resolved">REZOLVAT</option>
                    </select>
                </div>
                <div id="listAcad" class="list-container">
                    </div>
            </div>
        </div>

    </main>
    
    <script>
        // --- CONSTANTE »òI VARIABILE DE STARE ---
        const KEY = 'school_hub_state_v4_3';
        const ADMIN_PASSWORD = '1234';
        let isAdminMode = localStorage.getItem('isAdminModeActive') === 'true'; // Preluare stare admin de la ultimul refresh

        let state = JSON.parse(localStorage.getItem(KEY)) || {
            probleme: [], // SesizƒÉri probleme (loca»õie, echipament, status)
            bullying: [], // RaportƒÉri bullying (strict confiden»õiale, doar pentru admin)
            sugestii: [], // Sugestii »ôi idei
            acad: [], // SolicitƒÉri sprijin academic/consiliere
            announcements: [], // Anun»õuri oficiale (de la admin)
            calendar: [], // Evenimente programate
            poll: null, // Sondaj curent (titlu, op»õiuni, voturi, hasVoted)
            lastSeenAnnouncementId: 0 // ID-ul ultimului anun»õ vƒÉzut
        };

        // --- INI»öIALIZARE STATE V4.3 ---
        
        // AsigurƒÉ cƒÉ toate colec»õiile au array-uri de comentarii (chiar dacƒÉ unele nu sunt afi»ôate public)
        state.probleme = state.probleme.map(p => ({ ...p, comments: p.comments || [] }));
        state.sugestii = state.sugestii.map(s => ({ ...s, comments: s.comments || [] }));
        state.acad = state.acad.map(a => ({ ...a, comments: a.comments || [] }));
        state.bullying = state.bullying.map(b => ({ ...b, comments: b.comments || [] })); // Bullying NU are comentarii vizibile public
        
        // Con»õinut ini»õial (dacƒÉ lipsesc datele)
        if(!state.poll || !state.poll.options) {
            state.poll = {
                title:'Ce activitate vrei prioritizatƒÉ √Æn urmƒÉtoarea lunƒÉ?', 
                options:['Club foto', 'Atelier teatru', 'Green corner'], 
                votes:new Array(3).fill(0), 
                hasVoted: false
            };
        } else if(!state.poll.votes || state.poll.votes.length !== state.poll.options.length) {
             // AsigurƒÉ cƒÉ vectorul de voturi corespunde op»õiunilor
             state.poll.votes = new Array(state.poll.options.length).fill(0);
        }
        
        if(!state.calendar || state.calendar.length === 0) {
            state.calendar = [
                {id: 1, title: "Simulare BAC (Rom√¢nƒÉ, MatematicƒÉ)", date: "2026-01-20"},
                {id: 2, title: "»òedin»õƒÉ cu PƒÉrin»õii", date: "2025-12-15"},
                {id: 3, title: "Ziua Por»õilor Deschise", date: "2026-03-05"}
            ];
        }

        // SorteazƒÉ evenimentele cronologic
        state.calendar.sort((a, b) => new Date(a.date) - new Date(b.date));
        // --- Sf√¢r»ôit Ini»õializare State V4.3 ---

        // Cache DOM elements
        const listProbleme=document.getElementById('listProbleme'),listBullying=document.getElementById('listBullying'),listSugestii=document.getElementById('listSugestii'),listAcad=document.getElementById('listAcad'),countsSpan=document.getElementById('counts'),navLinks=document.getElementById('navLinks'),burger=document.getElementById('burger'),toTopBtn=document.getElementById('toTop'),voteBtn=document.getElementById('voteBtn'),resetVoteBtn=document.getElementById('resetVote'),pollOptionsDiv=document.getElementById('pollOptions'),pollControlsDiv=document.getElementById('pollControls'),pollResultsDiv=document.getElementById('pollResults'),formProbleme=document.getElementById('formProbleme'),formBullying=document.getElementById('formBullying'),formSugestii=document.getElementById('formSugestii'),formAcademice=document.getElementById('formAcademice'),addAnnouncementForm=document.getElementById('addAnnouncementForm'),announcementsList=document.getElementById('announcementsList'),formAnnouncement=document.getElementById('formAnnouncement'),calendarList=document.getElementById('calendarList'),addEventForm=document.getElementById('formEvent'),toast=document.getElementById('toast'),adminPollControls=document.getElementById('adminPollControls'),startNewPollBtn=document.getElementById('startNewPoll'), announcementBadge=document.getElementById('announcement-badge'), progressBar=document.getElementById('progressBar'), progressPercent=document.getElementById('progressPercent'), adminSidebar=document.getElementById('adminSidebar'), mainGrid=document.getElementById('mainGrid'), adminContent=document.getElementById('adminContent');
        
        // Utility Functions
        function persist(){ localStorage.setItem(KEY, JSON.stringify(state)); }
        function statusClass(s){ if(s==='open') return 'open'; if(s==='inprogress') return 'progress'; return 'resolved'; }
        function statusLabel(s){ if(s==='open') return 'OPEN'; if(s==='inprogress') return '√éN LUCRU'; return 'REZOLVAT'; }
        function nextId(collection) { return (collection.length > 0 ? Math.max(...collection.map(item => item.id)) : 0) + 1; }
        
        function showToast(message, isError = false){
            toast.innerHTML = isError ? `‚ö†Ô∏è ${message}` : `‚úÖ ${message}`;
            toast.style.background = isError ? '#ef4444' : '#1e3a8a';
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function markAnnouncementsSeen() {
            if (state.announcements.length > 0) {
                state.lastSeenAnnouncementId = state.announcements[0].id;
                persist();
                renderTopBar();
            }
        }
        
        function renderTopBar() {
            const lastSeen = state.lastSeenAnnouncementId || 0;
            const newAnnouncements = state.announcements.filter(a => a.id > lastSeen).length;
            
            if (newAnnouncements > 0) {
                announcementBadge.textContent = newAnnouncements;
                announcementBadge.style.display = 'inline-block';
            } else {
                announcementBadge.style.display = 'none';
            }
        }

        function renderProgress() {
            const totalProblems = state.probleme.length + state.acad.length;
            const resolvedProblems = state.probleme.filter(p => p.status === 'resolved').length + state.acad.filter(a => a.status === 'resolved').length;
            
            let percent = 0;
            if (totalProblems > 0) {
                percent = Math.round((resolvedProblems / totalProblems) * 100);
            }

            progressPercent.textContent = `${percent}%`;
            progressBar.style.width = `${percent}%`;
            countsSpan.textContent = `Total: ${totalProblems} | Rezolvate: ${resolvedProblems}`;
        }

        // --- Randare GenericƒÉ ListƒÉ (cu Comentarii »ôi Admin Controls) ---
        function renderList(listElement, data, type, showFilters = false) {
            listElement.innerHTML = '';
            
            // Logica de filtrare/cƒÉutare (aplicabilƒÉ doar la Probleme »ôi Academice)
            let filteredData = [...data].reverse(); // Cele mai noi primele
            const searchId = document.getElementById(`search${type}`) ? document.getElementById(`search${type}`).value.toLowerCase() : '';
            const statusId = document.getElementById(`statusFilter${type}`) ? document.getElementById(`statusFilter${type}`).value : 'all';

            if (showFilters && isAdminMode) {
                document.getElementById(`filter${type}`).style.display = 'flex';
                
                // Filtrare dupƒÉ status
                if (statusId !== 'all') {
                    filteredData = filteredData.filter(item => item.status === statusId);
                }

                // Filtrare dupƒÉ text
                if (searchId) {
                    filteredData = filteredData.filter(item => 
                        (item.locatie && item.locatie.toLowerCase().includes(searchId)) ||
                        (item.tip && item.tip.toLowerCase().includes(searchId)) ||
                        (item.descr && item.descr.toLowerCase().includes(searchId)) ||
                        (item.numeSug && item.numeSug.toLowerCase().includes(searchId)) ||
                        (item.email && item.email.toLowerCase().includes(searchId))
                    );
                }
            } else if(showFilters && document.getElementById(`filter${type}`)) {
                 document.getElementById(`filter${type}`).style.display = 'none';
            }

            if (filteredData.length === 0) {
                listElement.innerHTML = `<div style="padding:15px; text-align:center; color:var(--muted); font-style:italic;">Nu existƒÉ √ÆnregistrƒÉri √Æn aceastƒÉ categorie.</div>`;
                return;
            }

            filteredData.forEach(item => {
                let thumbContent = '';
                let statusInfo = '';
                let details = '';
                let categoryClass = '';
                let date = new Date(item.date).toLocaleDateString('ro-RO', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }).replace(',', ' ');
                
                // Setare detalii specifice tipului
                switch(type) {
                    case 'Probleme':
                        categoryClass = 'cat-probleme';
                        statusInfo = `<span class="status ${statusClass(item.status)}">${statusLabel(item.status)}</span>`;
                        thumbContent = item.foto ? `<img src="${item.foto}" alt="Foto">` : `<svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M11 9h2v6h-2V9zm0-4h2v2h-2V5zM12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2z"/></svg>`;
                        details = `<p style="font-size:14px; margin: 4px 0 0;"><strong>Loca»õie:</strong> ${item.locatie || 'Nespecificat'}</p>
                                    <p style="font-size:14px; margin: 2px 0 0;"><strong>Tip:</strong> ${item.tip || 'Alte probleme'}</p>`;
                        break;
                    case 'Bullying':
                        categoryClass = 'cat-bullying';
                        thumbContent = `<svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a7 7 0 0 0-7 7v3H3l4 4v3h10v-3l4-4h-2V9a7 7 0 0 0-7-7z"/></svg>`;
                        details = `<p style="font-size:14px; margin: 4px 0 0;"><strong>Tip:</strong> ${item.tip || 'General'}</p>`;
                        if (isAdminMode) {
                            details += `<p style="font-size:14px; margin: 2px 0 0; color:var(--probleme-color);"><strong>Contact:</strong> ${item.email || 'Anonim'}</p>`;
                        }
                        break;
                    case 'Sugestii':
                        categoryClass = 'cat-sugestii';
                        thumbContent = `<svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M9 21h6v-2H9v2zm6.6-10.2l-1.2 1.2-2.4-2.4L9 13.8V7h6.6zM3 5h6V3H3v2z"/></svg>`;
                        details = `<p style="font-size:14px; margin: 4px 0 0;"><strong>Autor:</strong> ${item.numeSug || 'Anonim'}</p>`;
                        break;
                    case 'Acad':
                        categoryClass = 'cat-acad';
                        statusInfo = `<span class="status ${statusClass(item.status)}">${statusLabel(item.status)}</span>`;
                        thumbContent = `<svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2L1 7l11 5 9-4.09V17h2V7L12 2z"/></svg>`;
                        details = `<p style="font-size:14px; margin: 4px 0 0;"><strong>Tip:</strong> ${item.tip || 'General'}</p>`;
                        break;
                }

                let commentsHtml = '';
                // Comentariile NU sunt afi»ôate pentru Bullying
                if (type !== 'Bullying') { 
                    const commentCount = item.comments.length;
                    
                    // Numele autorului pentru Comentarii trebuie sƒÉ fie consistent
                    const commentType = type === 'Sugestii' ? 'Sugestii' : (type === 'Acad' ? 'Acad' : 'Probleme');

                    commentsHtml = `
                        <div class="comments-section">
                            <h4 style="margin: 0 0 8px; font-size: 14px; color:var(--primary); font-weight: 700;">Comentarii (${commentCount})</h4>
                            <div style="max-height: 150px; overflow-y: auto; padding-right: 5px;">
                                ${item.comments.map(c => `
                                    <div class="comment-item">
                                        ${c.text}
                                        <span class="comment-meta">${c.author} | ${new Date(c.date).toLocaleDateString('ro-RO')}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="comment-form-container">
                                <textarea id="commentText${commentType}${item.id}" placeholder="AdaugƒÉ un comentariu (Nume: op»õional)"></textarea>
                                <button class="btn" onclick="addComment('${commentType}', ${item.id}, document.getElementById('commentText${commentType}${item.id}').value)">ComenteazƒÉ</button>
                            </div>
                        </div>
                    `;
                } 

                // Generare Admin Controls (vizibile doar √Æn Mod Admin)
                let adminControlsHtml = '';
                if (isAdminMode && (type === 'Probleme' || type === 'Acad' || type === 'Bullying' || type === 'Sugestii')) {
                    const statusOptions = ['open', 'inprogress', 'resolved'].map(s => 
                        `<option value="${s}" ${item.status === s ? 'selected' : ''}>${statusLabel(s)}</option>`
                    ).join('');

                    // Bullying »ôi Sugestii nu au status, dar au op»õiune de »ôtergere
                    if (type !== 'Bullying' && type !== 'Sugestii') {
                        adminControlsHtml = `
                            <div class="admin-controls">
                                <label style="font-size:14px; color:var(--muted); font-weight:600;">SchimbƒÉ status:</label>
                                <select onchange="changeStatus('${type}', ${item.id}, this.value)">
                                    ${statusOptions}
                                </select>
                                <button class="btn urgent" style="flex-grow:1;" onclick="deleteItem('${type}', ${item.id})">»òterge</button>
                            </div>
                        `;
                    } else {
                        // Pentru Sugestii »ôi Bullying (fƒÉrƒÉ status)
                        adminControlsHtml = `
                            <div class="admin-controls">
                                <button class="btn urgent" style="width:100%;" onclick="deleteItem('${type}', ${item.id})">»òterge ${type === 'Bullying' ? 'Raportare' : 'Sugestie'}</button>
                            </div>
                        `;
                    }
                }

                listElement.innerHTML += `
                    <div class="item ${categoryClass}" data-id="${item.id}">
                        <div style="display:flex;gap:12px;align-items:flex-start">
                            <div class="thumb">${thumbContent}</div>
                            <div style="flex-grow:1;">
                                <div style="display:flex;justify-content:space-between;align-items:flex-start">
                                    <div style="font-weight:700;font-size:15px;color:#111; max-width: 80%;">${item.descr.substring(0, 100)}${item.descr.length > 100 ? '...' : ''}</div>
                                    ${statusInfo}
                                </div>
                                ${details}
                                <div class="meta" style="margin-top: 5px;">Trimis la: ${date}</div>
                            </div>
                        </div>
                        ${adminControlsHtml}
                        ${commentsHtml}
                    </div>
                `;
            });

            // AsigurƒÉ cƒÉ func»õiile de auto-resize la textarea commenteazƒÉ func»õioneazƒÉ.
            listElement.querySelectorAll('textarea').forEach(textarea => {
                textarea.addEventListener('input', () => {
                    textarea.style.height = 'auto';
                    textarea.style.height = (textarea.scrollHeight) + 'px';
                });
            });
        }
        
        // --- Randare Liste Specifice ---
        function renderProbleme() { renderList(listProbleme, state.probleme, 'Probleme', true); renderProgress(); }
        function renderBullying() { 
            const bullyingListTitle = document.getElementById('bullyingListTitle');
            if(bullyingListTitle) bullyingListTitle.style.display = isAdminMode ? 'block' : 'none';
            listBullying.style.display = isAdminMode ? 'flex' : 'none';
            if (isAdminMode) {
                 renderList(listBullying, state.bullying, 'Bullying'); 
            }
        }
        function renderSugestii() { renderList(listSugestii, state.sugestii, 'Sugestii'); }
        function renderAcad() { renderList(listAcad, state.acad, 'Acad', true); renderProgress(); }
        
        // --- Randare Anun»õuri ---
        function renderAnnouncements() {
            announcementsList.innerHTML = '';
            const sortedAnnouncements = [...state.announcements].reverse(); // Cel mai nou primul

            if (sortedAnnouncements.length === 0) {
                 announcementsList.innerHTML = `<div style="padding:15px; text-align:center; color:var(--muted); font-style:italic;">Nu existƒÉ anun»õuri oficiale.</div>`;
                 return;
            }

            sortedAnnouncements.forEach(ann => {
                const date = new Date(ann.date).toLocaleDateString('ro-RO');
                const isNew = ann.id > state.lastSeenAnnouncementId;
                const isUrgent = ann.type === 'Urgent';
                
                announcementsList.innerHTML += `
                    <div class="item cat-resurse" style="border-left:5px solid ${isUrgent ? 'var(--probleme-color)' : 'var(--resurse-color)'};">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                             <div style="font-weight:700; font-size:15px; color:#111;">
                                 ${ann.type} ${isNew ? '<span class="status open" style="margin-left:8px;">NOU</span>' : ''}
                             </div>
                             ${isAdminMode ? `<button class="btn urgent" style="padding:4px 8px; font-size:11px;" onclick="deleteItem('Announcements', ${ann.id})">»òterge</button>` : ''}
                        </div>
                        <p style="font-size:14px; margin: 4px 0 6px;">${ann.descr}</p>
                        <div class="meta">Publicat la: ${date}</div>
                    </div>
                `;
            });
            // MarcheazƒÉ anun»õurile ca vƒÉzute c√¢nd sunt afi»ôate
            markAnnouncementsSeen();
        }

        // --- Randare Sondaj ---
        function renderPoll() {
            const poll = state.poll;
            document.getElementById('currentPollTitle').textContent = poll.title;
            pollOptionsDiv.innerHTML = '';
            pollResultsDiv.innerHTML = '';
            
            // Administrare vizibilitate
            if(adminPollControls) adminPollControls.style.display = isAdminMode ? 'block' : 'none';
            if(pollControlsDiv) pollControlsDiv.style.display = 'flex'; // Votul/Resetul e vizibil
            if(resetVoteBtn) resetVoteBtn.style.display = isAdminMode ? 'block' : 'none'; // Reset vot vizibil doar admin
            
            
            // Op»õiuni vot
            if (!poll.hasVoted || isAdminMode) {
                poll.options.forEach((option, index) => {
                    pollOptionsDiv.innerHTML += `
                        <label style="font-size:14px; display:flex; gap:8px; align-items:center;">
                            <input type="radio" name="pollOption" value="${index}" ${poll.hasVoted && !isAdminMode ? 'disabled' : ''}> 
                            ${option}
                        </label>
                    `;
                });
                if(voteBtn) {
                    voteBtn.onclick = handleVote;
                    voteBtn.disabled = poll.hasVoted && !isAdminMode;
                    voteBtn.textContent = poll.hasVoted && !isAdminMode ? 'Ai Votat' : 'VoteazƒÉ';
                }
            } else {
                pollOptionsDiv.innerHTML = '<p style="color:var(--muted); font-style:italic;">Ai votat deja. Vezi rezultatele mai jos.</p>';
            }
            
            // Rezultate
            const totalVotes = poll.votes.reduce((sum, current) => sum + current, 0);
            poll.options.forEach((option, index) => {
                const votes = poll.votes[index];
                const percent = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
                pollResultsDiv.innerHTML += `
                    <div style="font-size:14px; font-weight:600; color:var(--muted); margin-bottom: 2px;">${option} (${votes} voturi / ${percent}%)</div>
                    <div class="bar" style="margin-bottom:10px;">
                        <span style="width:${percent}%"></span>
                    </div>
                `;
            });
            pollResultsDiv.innerHTML += `<div style="font-size:12px; font-weight:700; text-align:right; color:var(--primary);">Total Voturi: ${totalVotes}</div>`;
        }
        
        // --- Randare Calendar ---
        function renderCalendar() {
            calendarList.innerHTML = '';
            if (addEventForm) addEventForm.parentNode.style.display = isAdminMode ? 'block' : 'none';
            
            if (state.calendar.length === 0) {
                 calendarList.innerHTML = `<div style="padding:15px; text-align:center; color:var(--muted); font-style:italic;">Nu sunt evenimente programate.</div>`;
                 return;
            }

            state.calendar.forEach(event => {
                const date = new Date(event.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0); // NormalizeazƒÉ pentru compara»õie corectƒÉ
                const isPast = date < today;
                const day = date.getDate().toString().padStart(2, '0');
                const month = date.toLocaleDateString('ro-RO', { month: 'short' });

                calendarList.innerHTML += `
                    <div style="display:flex;gap:12px;align-items:flex-start;padding:8px;border-bottom:1px solid #eee; opacity:${isPast ? 0.6 : 1};">
                        <div style="width:40px;height:40px;border-radius:6px;background:${isPast ? '#ccc' : 'var(--primary)'};color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;">
                            <div>${day}</div>
                            <div style="text-transform:uppercase;font-size:10px;margin-top:-2px;">${month.substring(0, 3)}</div>
                        </div>
                        <div style="flex-grow:1; font-size:14px; color:#333;">
                            <div style="font-weight:600;">${event.title}</div>
                            <div style="font-size:12px; color:var(--muted);">${new Date(event.date).toLocaleDateString('ro-RO')}</div>
                        </div>
                        ${isAdminMode ? `<button class="btn urgent" style="padding:4px 8px; font-size:11px;" onclick="deleteItem('Calendar', ${event.id})">»òterge</button>` : ''}
                    </div>
                `;
            });
        }
        
        // --- Func»õii de Administrare Date ---
        function changeStatus(type, id, newStatus) {
            if (!isAdminMode) return;
            const collectionName = type.toLowerCase();
            const index = state[collectionName].findIndex(item => item.id === id);
            
            if (index > -1) {
                state[collectionName][index].status = newStatus;
                persist();
                showToast(`Statusul pentru ${type} #${id} a fost actualizat la ${statusLabel(newStatus)}.`);
                // RerandeazƒÉ lista afectatƒÉ
                if (type === 'Probleme') renderProbleme();
                else if (type === 'Acad') renderAcad();
                renderProgress();
            }
        }

        function deleteItem(type, id) {
             if (!isAdminMode) {
                 showToast('Nu ai permisiunea de a »ôterge elemente.', true);
                 return;
             }
             if (!confirm(`E»ôti sigur cƒÉ vrei sƒÉ »ôtergi acest element din sec»õiunea ${type} (ID: ${id})? AceastƒÉ ac»õiune este permanentƒÉ.`)) {
                 return;
             }
            
            const collectionName = type === 'Announcements' ? 'announcements' : (type === 'Calendar' ? 'calendar' : type.toLowerCase());
            state[collectionName] = state[collectionName].filter(item => item.id !== id);
            
            persist();
            showToast(`${type} (ID: ${id}) a fost »ôters.`);
            
            // RerandeazƒÉ sec»õiunile
            if (type === 'Probleme') renderProbleme();
            else if (type === 'Bullying') renderBullying();
            else if (type === 'Sugestii') renderSugestii();
            else if (type === 'Acad') renderAcad();
            else if (type === 'Announcements') renderAnnouncements();
            else if (type === 'Calendar') renderCalendar();
            
            renderProgress();
            renderTopBar(); // Poate afecta badge-ul de anun»õuri
        }

        // --- FIX Comentarii ---
        function addComment(type, id, commentText) {
            let collectionName;
            
            // Fix: MapeazƒÉ numele de tip la cheia corectƒÉ din state
            if (type === 'Probleme') collectionName = 'probleme';
            else if (type === 'Sugestii') collectionName = 'sugestii';
            else if (type === 'Acad') collectionName = 'acad';
            else { showToast('Tip de colec»õie invalid pentru comentariu.', true); return; }

            let author = 'Anonim';
            let text = commentText.trim();
            
            // Logica de extragere nume
            const nameMatch = text.match(/nume:(\s*)?([^()]+)/i);
            const parentheseMatch = text.match(/\(([^)]+)\)$/);
            
            if (nameMatch) {
                author = nameMatch[2].trim();
                text = text.replace(nameMatch[0], '').trim();
            } else if (parentheseMatch && parentheseMatch[1].length > 0 && parentheseMatch[1].length < 20) {
                 author = parentheseMatch[1].trim();
                 text = text.replace(parentheseMatch[0], '').trim();
            }

            if (text.length < 5) {
                showToast('Comentariul este prea scurt (minim 5 caractere).', true);
                return;
            }

            const item = state[collectionName].find(i => i.id === id);
            
            if (item) {
                item.comments.push({
                    text: text,
                    author: author,
                    date: new Date().toISOString()
                });
                persist();
                showToast(`Comentariul a fost adƒÉugat la ${type} #${id}.`);
                
                // CurƒÉ»õƒÉ »ôi re-rendeazƒÉ lista corespunzƒÉtoare
                document.getElementById(`commentText${type}${id}`).value = '';
                if (type === 'Probleme') renderProbleme();
                else if (type === 'Sugestii') renderSugestii();
                else if (type === 'Acad') renderAcad();
            }
        }
        
        // --- Securitate »ôi Mod Admin ---
        
        document.getElementById('toggleAdmin').addEventListener('click', toggleAdmin);

        function updateAdminUI() {
            const button = document.getElementById('toggleAdmin');
            
            if (isAdminMode) {
                // Mod Admin Activ: Afi»ôeazƒÉ sidebar, schimbƒÉ grila, actualizeazƒÉ butonul
                adminSidebar.classList.add('admin-visible');
                mainGrid.classList.add('admin-visible');
                adminContent.style.display = 'block'; 
                button.textContent = 'Ie»ôi Mod Admin';
                button.classList.add('urgent');
            } else {
                // Mod Normal Activ
                adminSidebar.classList.remove('admin-visible');
                mainGrid.classList.remove('admin-visible');
                adminContent.style.display = 'none'; 
                button.textContent = 'IntrƒÉ Mod Admin';
                button.classList.remove('urgent');
            }

            // Re-rendeazƒÉ tot
            renderProbleme();
            renderBullying();
            renderSugestii(); 
            renderAcad();
            renderAnnouncements();
            renderCalendar();
            renderPoll();
            
            // Administrare vizibilitate formulare Admin
            if(addAnnouncementForm) addAnnouncementForm.style.display = isAdminMode ? 'block' : 'none';
            if(adminPollControls) adminPollControls.style.display = isAdminMode ? 'block' : 'none';
            if(addEventForm) addEventForm.parentNode.style.display = isAdminMode ? 'block' : 'none';
            
            // BarƒÉ de progres vizibilƒÉ doar √Æn Mod Admin
            const progressContainer = document.getElementById('progressContainer');
            if(progressContainer) progressContainer.style.display = isAdminMode ? 'block' : 'none';
            if(countsSpan) countsSpan.style.display = isAdminMode ? 'block' : 'none';
            if (isAdminMode) renderProgress(); 
        }
        
        function toggleAdmin() {
            if (isAdminMode) {
                // Ie»ôire din Mod Admin
                isAdminMode = false;
                showToast('Mod Admin dezactivat. VƒÉzut ca elev.');
            } else {
                // √éncercare de a intra √Æn Mod Admin
                const password = prompt("üîí Introduce»õi parola de administrare (1234):");

                if (password === ADMIN_PASSWORD) { // Verificare directƒÉ cu parola fixƒÉ
                    isAdminMode = true;
                    showToast('Acces Admin acordat.');
                } else if (password !== null) {
                    showToast('ParolƒÉ incorectƒÉ.', true);
                    return;
                } else {
                    return; // Anulare
                }
            }

            updateAdminUI();
            // PƒÉstrƒÉm starea de admin activƒÉ la reload (op»õional, dar util)
            localStorage.setItem('isAdminModeActive', isAdminMode); 
        }

        // --- Event Listeners (Trimitere Formulare) ---
        
        // 1. Probleme
        document.getElementById('sendProblema').addEventListener('click', () => sendProblem(false));
        document.getElementById('sendProblemaUrgent').addEventListener('click', () => sendProblem(true));
        document.getElementById('clearProblema').addEventListener('click', () => formProbleme.reset());
        document.getElementById('fotoProblema').addEventListener('change', previewImage);
        
        document.getElementById('contactBullying').addEventListener('change', (e) => {
            document.getElementById('emailBullying').disabled = !e.target.checked;
            if (!e.target.checked) document.getElementById('emailBullying').value = '';
        });

        function sendProblem(isUrgent) {
            const descr = document.getElementById('descrProblema').value.trim();
            const locatie = document.getElementById('locatie').value.trim();
            const tip = document.getElementById('tipProblema').value.trim();
            const fotoInput = document.getElementById('fotoProblema');
            let fotoBase64 = null;

            if (descr.length < 5) { showToast('Descrierea este prea scurtƒÉ.', true); return; }
            if (!locatie) { showToast('Introduce»õi o loca»õie (ex: Sala 204).', true); return; }
            if (!tip) { showToast('Selecta»õi tipul problemei.', true); return; }
            
            const processSubmission = (base64) => {
                const newId = nextId(state.probleme);
                const newProblem = {
                    id: newId,
                    locatie: locatie,
                    tip: tip,
                    descr: descr,
                    foto: base64,
                    date: new Date().toISOString(),
                    status: 'open',
                    urgent: isUrgent,
                    comments: []
                };
                state.probleme.push(newProblem);
                persist();
                formProbleme.reset();
                document.getElementById('previewProblema').innerHTML = '';
                showToast(`Sesizarea #${newId} a fost trimisƒÉ cu succes! ${isUrgent ? 'URGENT' : ''}`);
                renderProbleme();
            };

            if (fotoInput.files.length > 0) {
                const file = fotoInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    // LimiteazƒÉ dimensiunea imaginii la 300KB
                    if (e.target.result.length > 300000) { 
                        showToast('Imaginea este prea mare (max 300KB). VƒÉ rugƒÉm folosi»õi o imagine mai micƒÉ.', true); 
                        return;
                    }
                    processSubmission(e.target.result);
                };
                reader.onerror = function() {
                    showToast('Eroare la citirea fi»ôierului foto.', true);
                };
                reader.readAsDataURL(file);
            } else {
                processSubmission(null);
            }
        }

        function previewImage(event) {
            const previewDiv = document.getElementById('previewProblema');
            previewDiv.innerHTML = '';
            const files = event.target.files;
            if (files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewDiv.innerHTML = `<div class="thumb" style="width:100px; height:100px; margin:0 auto;"><img src="${e.target.result}" alt="Preview"></div>`;
                };
                reader.readAsDataURL(files[0]);
            }
        }
        
        // 2. Bullying
        document.getElementById('sendBullying').addEventListener('click', sendBullying);
        if(document.getElementById('clearBullying')) document.getElementById('clearBullying').addEventListener('click', () => formBullying.reset());

        function sendBullying() {
            const tip = document.getElementById('tipBullying').value.trim();
            const descr = document.getElementById('descrBullying').value.trim();
            const contact = document.getElementById('contactBullying').checked;
            const email = document.getElementById('emailBullying').value.trim();

            if (descr.length < 5) { showToast('Descrierea este prea scurtƒÉ.', true); return; }
            if (contact && (!email || !email.includes('@'))) { showToast('Introduce»õi un email valid dacƒÉ dori»õi sƒÉ fi»õi contactat.', true); return; }
            
            const newId = nextId(state.bullying);
            const newBullying = {
                id: newId,
                tip: tip || 'Anonim',
                descr: descr,
                email: contact ? email : null,
                date: new Date().toISOString(),
                comments: [] // Comentariile nu sunt afi»ôate public la bullying
            };
            state.bullying.push(newBullying);
            persist();
            formBullying.reset();
            showToast(`Raportarea #${newId} a fost trimisƒÉ anonim.`);
            // Nu rerandeazƒÉ lista pentru utilizatorul normal, doar pentru admin la urmƒÉtoarea logare/refresh
        }

        // 3. Sugestii
        document.getElementById('sendSug').addEventListener('click', sendSugestie);
        if(document.getElementById('clearSug')) document.getElementById('clearSug').addEventListener('click', () => formSugestii.reset());

        function sendSugestie() {
            const nume = document.getElementById('numeSug').value.trim();
            const descr = document.getElementById('descrSug').value.trim();
            
            if (descr.length < 5) { showToast('Descrierea este prea scurtƒÉ.', true); return; }

            const newId = nextId(state.sugestii);
            const newSugestie = {
                id: newId,
                numeSug: nume || 'Anonim',
                descr: descr,
                date: new Date().toISOString(),
                comments: []
            };
            state.sugestii.push(newSugestie);
            persist();
            formSugestii.reset();
            showToast(`Sugestia #${newId} a fost trimisƒÉ.`);
            renderSugestii();
        }

        // 4. Academice
        document.getElementById('sendAcad').addEventListener('click', sendAcad);
        if(document.getElementById('clearAcad')) document.getElementById('clearAcad').addEventListener('click', () => formAcademice.reset());

        function sendAcad() {
            const tip = document.getElementById('tipAcad').value.trim();
            const descr = document.getElementById('descrAcad').value.trim();
            
            if (descr.length < 5) { showToast('Descrierea este prea scurtƒÉ.', true); return; }
            if (!tip) { showToast('Selecta»õi tipul de sprijin academic.', true); return; }

            const newId = nextId(state.acad);
            const newAcad = {
                id: newId,
                tip: tip,
                descr: descr,
                date: new Date().toISOString(),
                status: 'open',
                comments: []
            };
            state.acad.push(newAcad);
            persist();
            formAcademice.reset();
            showToast(`Solicitarea academicƒÉ #${newId} a fost trimisƒÉ.`);
            renderAcad();
        }

        // 5. Anun»õuri (Admin)
        document.getElementById('sendAnunt').addEventListener('click', sendAnnouncement);

        function sendAnnouncement() {
            if (!isAdminMode) return;
            const type = document.getElementById('tipAnunt').value;
            const descr = document.getElementById('descrAnunt').value.trim();

            if (descr.length < 10) { showToast('Textul anun»õului este prea scurt.', true); return; }

            const newId = nextId(state.announcements);
            const newAnnouncement = {
                id: newId,
                type: type,
                descr: descr,
                date: new Date().toISOString()
            };
            // AdaugƒÉ la √Ænceputul listei (cel mai nou primul)
            state.announcements.unshift(newAnnouncement); 
            state.lastSeenAnnouncementId = newId - 1; // For»õeazƒÉ afi»ôarea ca NOU pentru ceilal»õi
            persist();
            formAnnouncement.reset();
            showToast(`Anun»õul #${newId} a fost publicat.`);
            renderAnnouncements();
        }

        // 6. Evenimente (Admin)
        document.getElementById('sendEvent').addEventListener('click', sendEvent);

        function sendEvent() {
            if (!isAdminMode) return;
            const title = document.getElementById('titluEvent').value.trim();
            const date = document.getElementById('dataEvent').value.trim();

            if (title.length < 5 || !date) { showToast('Titlul »ôi data evenimentului sunt necesare.', true); return; }
            
            const newId = nextId(state.calendar);
            const newEvent = {
                id: newId,
                title: title,
                date: date
            };
            state.calendar.push(newEvent);
            state.calendar.sort((a, b) => new Date(a.date) - new Date(b.date)); // SorteazƒÉ cronologic
            persist();
            document.getElementById('formEvent').reset();
            showToast(`Evenimentul '${title}' a fost adƒÉugat.`);
            renderCalendar();
        }

        // --- Func»õii Sondaj ---
        function handleVote() {
            if (state.poll.hasVoted && !isAdminMode) {
                 showToast('Ai votat deja la acest sondaj.', true);
                 return;
            }
            const selectedOption = document.querySelector('input[name="pollOption"]:checked');
            if (!selectedOption) {
                showToast('Selecta»õi o op»õiune √Ænainte de a vota.', true);
                return;
            }

            const index = parseInt(selectedOption.value);
            state.poll.votes[index]++;
            state.poll.hasVoted = true;
            persist();
            showToast('Votul a fost √Ænregistrat. Mul»õumim!');
            renderPoll();
        }

        document.getElementById('resetVote').addEventListener('click', () => {
             if (!isAdminMode) return;
            state.poll.votes = new Array(state.poll.options.length).fill(0);
            state.poll.hasVoted = false; // Poate fi resetat »ôi votul elevului dacƒÉ e necesar
            persist();
            showToast('Voturile la sondaj au fost resetate.');
            renderPoll();
        });
        
        document.getElementById('startNewPoll').addEventListener('click', () => {
            if (!isAdminMode) return;
            const title = document.getElementById('newPollTitle').value.trim();
            const optionsText = document.getElementById('newPollOptions').value.trim();

            if (!title || optionsText.split('\n').filter(o => o.trim()).length < 2) {
                showToast('Introduce»õi un titlu »ôi minim 2 op»õiuni (pe r√¢nduri noi).', true);
                return;
            }
            
            const options = optionsText.split('\n').map(o => o.trim()).filter(o => o);
            
            state.poll = {
                title: title,
                options: options,
                votes: new Array(options.length).fill(0),
                hasVoted: false // ResetƒÉm votul pentru noul sondaj
            };
            persist();
            document.getElementById('formNewPoll').reset();
            showToast('Sondajul nou a fost lansat!');
            renderPoll();
        });
        
        // --- Func»õii de Utilitate (Generale) ---

        // »òterge toate datele (Acum necesitƒÉ Mod Admin)
        document.getElementById('clearAll').addEventListener('click', () => {
            if (!isAdminMode) {
                 showToast('AceastƒÉ ac»õiune necesitƒÉ permisiuni de Admin.', true);
                 return;
            }

            // ATEN»öIE: »òterge »ôi starea 'isAdminModeActive', dar parola e fixƒÉ, deci nu e problemƒÉ.
            if (confirm("ATEN»öIE! AceastƒÉ ac»õiune va »ôterge TOATE datele salvate √Æn browser (sesizƒÉri, anun»õuri, voturi, parolƒÉ admin). E»ôti sigur?")) {
                localStorage.clear();
                window.location.reload(); 
            }
        });
        
        // --- Evenimente UI (Burger Menu, Scroll) ---
        burger.addEventListener('click', () => {
            navLinks.classList.toggle('show');
            burger.classList.toggle('open');
        });

        window.addEventListener('scroll', () => {
            if(toTopBtn) toTopBtn.classList.toggle('show', window.scrollY > 200);
            
            // Efect de reveal la carduri
            document.querySelectorAll('.card:not(.revealed)').forEach(card => {
                if (card.getBoundingClientRect().top < window.innerHeight - 100) {
                    card.classList.add('revealed');
                }
            });
        });

        if(toTopBtn) {
            toTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
        
        // --- Ini»õializare la √ÆncƒÉrcarea paginii ---
        document.addEventListener('DOMContentLoaded', () => {
            // Rerandare ini»õialƒÉ
            renderProbleme();
            renderBullying();
            renderSugestii();
            renderAcad();
            renderAnnouncements();
            renderCalendar();
            renderPoll();     
            
            renderTopBar();
            
            // Declara»õie pentru a preveni trimiterea formularului la Enter
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', (e) => e.preventDefault());
            });
            
            // AsigurƒÉ cƒÉ emailul e dezactivat by default
            const contactBullyingCheckbox = document.getElementById('contactBullying');
            const emailBullyingInput = document.getElementById('emailBullying');
            if (contactBullyingCheckbox && emailBullyingInput) {
                emailBullyingInput.disabled = !contactBullyingCheckbox.checked;
            }
            
            // ActiveazƒÉ efectul de reveal ini»õial pentru elementele vizibile
            document.querySelectorAll('.card').forEach(card => {
                if (card.getBoundingClientRect().top < window.innerHeight + 100) {
                    card.classList.add('revealed');
                }
            });

            // Re-activeazƒÉ Admin Mode (fƒÉrƒÉ a cere parola) dacƒÉ era activ la re√ÆncƒÉrcare
            if (localStorage.getItem('isAdminModeActive') === 'true') {
                isAdminMode = true;
                updateAdminUI(); // ActualizeazƒÉ doar UI-ul, nu cere relogare for»õatƒÉ
            } else {
                 // √én Mod Normal, ascunde complet con»õinutul Admin (fix pentru bug)
                 if(adminContent) adminContent.style.display = 'none';
            }
        });
        
        // Salvare stare isAdminMode √Ænainte de √Ænchidere/re√ÆncƒÉrcare
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('isAdminModeActive', isAdminMode);
        });
        
        // Face»õi func»õiile necesare disponibile global (pentru a fi apelate din onclick √Æn HTML)
        window.addComment = addComment; 
        window.changeStatus = changeStatus; 
        window.deleteItem = deleteItem;     

    </script>
</body>
</html>
